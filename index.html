<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Canvas text clip outline</title>
    </head>
    <body>
        <canvas width="320" height="240" id="canvas"></canvas>

        <script type="text/javascript">
            // (function () {
                var ctx = canvas.getContext('2d');
                var dragging = false;
                var canvasX = canvas.offsetLeft;
                var canvasY = canvas.offsetTop;
                var fontSize = parseInt(ctx.font.match(/\d+/), 10);
                var lineHeight = fontSize * 1;
                var text = 'Canvas text clip outline aaaaaaaaaaaaaaaaaand another additional very looooooooooooong or not so much long text';
                var maxStringWidth = 30;
                var padding = 8;
                var textArr = text.split(' ');
                var verticalHeight = 0;
                var verticalHalfHeight;

                for (var i = 0, current, next, str; i < textArr.length; i++) {
                    next = textArr[i + 1];

                    if (next) {
                        current = textArr[i];
                        str = current + ' ' + next;

                        if (ctx.measureText(str).width <= maxStringWidth) {
                            textArr[i] = str;
                            textArr.splice(i + 1, 1);
                            i--;
                        }
                    }
                }

                (function () {
                    for (var i = 0, imax = textArr.length; i < imax; i++) {
                        verticalHeight += lineHeight;
                    }
                })();

                verticalHalfHeight = verticalHeight / 2;

                draw(canvas.width / 2, canvas.height / 2);

                document.onmousedown = function (e) {
                    dragging = true;
                    document.onmousemove(e);
                };

                document.onmousemove = function (e) {
                    if (dragging) {
                        draw(e.pageX - canvasX, e.pageY - canvasY);
                    }
                };

                document.onmouseup = function () {
                    dragging = false;
                };

                function getOutlineRects (lineX, lineY) {
                    var textWidth;
                    var rects = [];
                    var currentRect, prevRect;
                    var overPositionDiff;

                    for (var i = 0, imax = textArr.length; i < imax; i++) {
                        textWidth = ctx.measureText(textArr[i]).width;

                        prevRect = currentRect;
                        currentRect = {};

                        currentRect.w = textWidth + padding * 2;
                        currentRect.h = lineHeight + padding * 2;
                        currentRect.x = lineX - currentRect.w / 2;
                        currentRect.y = lineY + lineHeight * i - padding - verticalHalfHeight;

                        overPositionDiff = prevRect ? prevRect.y + prevRect.h - currentRect.y : 0;

                        if (overPositionDiff > 0) {
                            if (prevRect.w > currentRect.w) {
                                currentRect.y += overPositionDiff;
                                currentRect.h -= overPositionDiff;
                            } else {
                                prevRect.h -= overPositionDiff;
                            }
                        }

                        rects.push(currentRect);
                    }

                    return rects;
                }

                function draw (lineX, lineY) {
                    var outlineRects = getOutlineRects(lineX / 2, lineY / 2);

                    drawBackgound();

                    // drawOutline(outlineRects);

                    ctx.save();
                    
                    // drawClipSectors(outlineRects);
                    clipOutline(outlineRects);

                    darawLine(lineX, lineY);
                    
                    ctx.restore();

                    drawText(lineX / 2, lineY / 2);
                }

                function drawText (lineX, lineY) {
                    var lineHeightOffset = (lineHeight - fontSize) / 2;

                    ctx.beginPath();
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';

                    for (var i = 0, imax = textArr.length; i < imax; i++) {
                        ctx.fillText(textArr[i], lineX, lineY + lineHeight * i - verticalHalfHeight + lineHeightOffset);
                    }
                }

                function darawLine (lineX, lineY) {
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.strokeStyle = '#000';
                    ctx.lineTo(lineX, lineY);
                    ctx.stroke();
                }

                function drawOutline (outlineRects) {
                    ctx.beginPath();
                    ctx.fillStyle = 'pink';

                    for (var i = 0, imax = outlineRects.length; i < imax; i++) {
                        ctx.fillRect(outlineRects[i].x, outlineRects[i].y, outlineRects[i].w, outlineRects[i].h);
                    }
                }

                function drawBackgound () {
                    ctx.beginPath();
                    ctx.fillStyle = '#ccc';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.beginPath();
                    ctx.strokeStyle = '#bfbcbc';
                    ctx.moveTo(canvas.width / 2, 0);
                    ctx.lineTo(canvas.width / 2, canvas.height);
                    ctx.moveTo(0, canvas.height / 2);
                    ctx.lineTo(canvas.width, canvas.height / 2);
                    ctx.stroke();
                }

                function drawClipSectors (outlineRects) {
                    var colors = [
                        'blue',
                        'green',
                        'purple',
                        'orange',
                        'aqua',
                        'indianred',
                    ];
                    var colorIndex = 0;
                    var firstRect = outlineRects[0];
                    var lastRect = outlineRects[outlineRects.length - 1];
                    var rect;

                    ctx.beginPath();

                    ctx.fillStyle = 'red';
                    ctx.fillRect(0, 0, canvas.width, firstRect.y);

                    for (var i = 0, imax = outlineRects.length; i < imax; i++) {
                        if (!colors[colorIndex]) {
                            colorIndex = 0;
                        }

                        rect = outlineRects[i];
                        
                        ctx.fillStyle = colors[colorIndex];
                        ctx.fillRect(0, rect.y, rect.x, rect.h);

                        ctx.fillStyle = colors[colorIndex + 1];
                        ctx.fillRect(rect.x + rect.w, rect.y, canvas.width - rect.x - rect.w, rect.h);

                        colorIndex += 2;
                    }

                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(0, lastRect.y + lastRect.h, canvas.width, canvas.height - lastRect.y + lastRect.h);
                }

                function clipOutline (outlineRects) {
                    var firstRect = outlineRects[0];
                    var lastRect = outlineRects[outlineRects.length - 1];
                    var rect;

                    ctx.beginPath();
                    
                    ctx.rect(0, 0, canvas.width, firstRect.y);

                    for (var i = 0, imax = outlineRects.length; i < imax; i++) {
                        rect = outlineRects[i];

                        ctx.rect(0, rect.y, rect.x, rect.h);
                        ctx.rect(rect.x + rect.w, rect.y, canvas.width - rect.x - rect.w, rect.h);
                    }

                    ctx.rect(0, lastRect.y + lastRect.h, canvas.width, canvas.height - lastRect.y + lastRect.h);

                    ctx.clip();
                }
            // })();
        </script>
    </body>
</html>